@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks
@inherits LayoutComponentBase
@inject IDialogService DialogService
@inject UserService UserService
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<MudThemeProvider Theme="PGASTheme" DefaultScrollbar="true" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Style="background-color: rgba(255, 255, 255, 0.8);backdrop-filter: blur(10px)" Elevation="0">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@DrawerToggle" />
        <MudImage Fluid="true" Width="200" Src="Objects/pgas eportal.webp"></MudImage>
        <MudSpacer />
        @if (eid?.eid != null)
        {
            <MudAvatar Variant="Variant.Outlined" Class="mud-border-dark">
                <MudImage Class="cursor-pointer"
                          Style="image-rendering: optimizeSpeed"
                          ObjectFit="ObjectFit.ScaleDown"
                          Src="@($"https://pgas.ph/hris/Content/images/photos/{eid.eid}.png")"
                          onerror="this.onerror=null;this.src='Objects/agusan del sur.webp';"
                          @onclick="OpenUserDialog">
                </MudImage>
            </MudAvatar>
        }
        else
        {
            <MudBadge Class="cursor-pointer" Content="@("Login")" OnClick="OpenLoginDialog" Origin="Origin.BottomCenter" Style="margin-top: -5px" Bordered="true" Overlap="true" Color="Color.Primary">
                <MudAvatar Variant="Variant.Outlined" Class="mud-border-dark">
                    <MudIconButton Class="pa-0" Size="Size.Large" OnClick="OpenLoginDialog" Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Tertiary">
                    </MudIconButton>
                </MudAvatar>
            </MudBadge>
        }
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Anchor="Anchor.Start" Elevation="0">
        <LeftNavMenu />
    </MudDrawer>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Anchor="Anchor.End" Elevation="0">
        <RightNavMenu />
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>
@code {
    private UserService.eportalUser? eid;

    MudTheme PGASTheme = new MudTheme()
        {
            Palette = new PaletteLight()
            {
                LinesInputs = Colors.Shades.Black,
                Primary = Colors.Blue.Default,
                Secondary = Colors.Yellow.Darken1,
                Tertiary = Colors.Grey.Darken4,
                AppbarBackground = Colors.Shades.White,
                AppbarText = Colors.Shades.Black,
                TextPrimary = Colors.Shades.Black
            },
            LayoutProperties = new LayoutProperties()
            {
                DrawerWidthLeft = "260px",
                DrawerWidthRight = "260px"
            }
        };

    bool _drawerOpen = true;

    protected override async Task OnInitializedAsync()
    {
        UserService.OnUserChanged += UpdateUser;
        await UpdateUserAsync();
    }

    private async Task UpdateUserAsync()
    {
        eid = await UserService.GetCurrentUserAsync();
        StateHasChanged();
    }

    private void UpdateUser()
    {
        // Calling the async method from a non-async method
        _ = UpdateUserAsync();
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void OpenLoginDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        DialogService.Show<Dialogues.Login>("", options);
    }

    private void OpenUserDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        DialogService.Show<Dialogues.UserPanel>("", options);
    }
}