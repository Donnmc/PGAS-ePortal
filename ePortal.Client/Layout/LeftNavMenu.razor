@using System.Text.Json
@using Blazored.LocalStorage;
@inject UserService UserService
@inherits LayoutComponentBase

<MudGrid Spacing="5" Class="pl-md-5 pt-md-5 pb-md-0 pr-md-0 pa-5">
    <MudItem xs="12">
        <MudNavMenu Rounded Color="Color.Primary">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
            <MudNavLink Href="/information-systems" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Apps">Information Systems</MudNavLink>
            <MudNavLink Href="/phone-directory" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocalPhone">Phone Directory</MudNavLink>
            <MudNavLink Href="/mobile-app" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.PhoneAndroid">Mobile App Corner</MudNavLink>
       
            @if (eid?.eid != null)
            {
                <MudNavLink Href="/employees" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Employees</MudNavLink>
                <MudNavGroup Icon="@Icons.Material.Filled.Settings" Title="Admin Settings">
                    <MudNavLink Href="/governor-images" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Image">Governor Images</MudNavLink>
                    <MudNavLink Href="/users-management" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.People">Users Management</MudNavLink>
                    <MudNavLink Href="/external-link" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.OpenInNew">External Links</MudNavLink>
                </MudNavGroup>
            }
            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Class="mt-3" Typo="Typo.subtitle2">External Links</MudText>
                <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.OpenInNew"></MudIcon>
            </MudStack>
           
            <MudPaper Width="250px" Class="py-3 mb-4" Elevation="0">
                        <MudNavMenu>
                           
             <MudNavGroup Title="USER's TOOL" Icon="@Icons.Material.Filled.FolderOpen" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="https://pgas.ph/pdm/status" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.List" Target="_blank">PR/PW Monitoring</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/eis/proposed" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewList" Target="_blank">Proposed Budget</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/eis/wfpsummary" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Summarize" Target="_blank">WFP Summary</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/ApprovalPR/wfpDetails#" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ListAlt" Target="_blank">Proc. Items/WFP</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/ProcTimelineCalc" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Calculate" Target="_blank">Proc. Timeline Calc</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spms/calendarofActivities/procurementcalendar" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CalendarMonth" Target="_blank">Proc. Calendar</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/SuppliersRating" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Star" Target="_blank">Supplier's Rating</MudNavLink>
                        <MudNavLink Href="https://reports.pgas.ph/Report/share/IHOMS/Hospital%20Medicine%20Inventory?Date=2025-04-16T09%3A18%3A03&hospitals=1%2C2%2C3%2C4%2C5&Showreorderonly=false&ShowBrand=false" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AllInbox" Target="_blank">Hospital Inventory</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/hrmis/public/officeutilization" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.StarOutline" Target="_blank">Performace Rating</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/eomis/public-summary" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ScreenshotMonitor" Target="_blank">POW Monitoring</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/GIS/ActivityDesign" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ViewList" Target="_blank">Venue Availability</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/eis/ldrrmf" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LineAxis" Target="_blank">LDRRMF Utilization</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/promis3/#!/nbwzrd/mapping" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Map" Target="_blank">Project Location</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/promis3/#!/nbwzrd/ppalist" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ListAlt" Target="_blank">List of Projects</MudNavLink>
                        <MudNavLink Href="https://reports.pgas.ph/Report/Share/Public/Project%20Profiling%20Report?recordid=" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LineStyle" Target="_blank">NGA Projects</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/SPMS/home/LPIIDashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocationSearching" Target="_blank">LPII</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/promis3/#!/nbwzrd/home" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SignalWifiStatusbarNull" Target="_blank">Project Status</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spms/home/publicIndex" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.GpsFixed" Target="_blank">Strategic Direction</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spms/CalendarofActivities/OrganizationalSchedule" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CalendarToday" Target="_blank">Calendar of Activities</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spms/ipccmonitoringhttps://pgas.ph/spms/ipccmonitoring" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Monitor" Target="_blank">IPCC Monitoring</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/paperlessmeeting" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Diversity3" Target="_blank">Meeting</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/aoms/Account/Login?ReturnUrl=%2Faoms%2F" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FileCopy" Target="_blank">Doc. Composer</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pimoforum" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Forum" Target="_blank">Knowledge Center</MudNavLink>

                    </MudNavGroup>
           
            </MudNavMenu>
            </MudPaper>

                        <MudPaper Width="250px" Class="py-3 mb-4" Elevation="0">
                        <MudNavMenu>
                            <MudStack Row AlignItems="AlignItems.Center">
                <MudText Class="mt-3" Typo="Typo.subtitle2">COMMON REPORT</MudText>
                    </MudStack><link href="c:\users\acer\sourcex\repos\pgas-eportal\eportal.client\layout\leftnavmenu.razor.css" rel="stylesheet" />
                    <MudNavGroup Title="Human Resource" Icon="@Icons.Material.Filled.FolderOpen" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="/travelers" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.DirectionsCar">Travelers</MudNavLink>
                        <MudNavLink Href="/dtrmanualentries" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AppRegistration">DTR Manual Entries</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epc" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CurrencyRuble" Target="_blank">Expense per Capita</MudNavLink>
                        <MudNavLink Href="/exempted-swiping" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.PersonPin">Exempted from Swiping</MudNavLink>
                        <MudNavLink Href="/travelled" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.DirectionsCarFilled">Travelled vs Did not Travelled</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/hris/reports/PersonelSummaryExternal" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.DashboardCustomize" Target="_blank">Dashboard</MudNavLink>
                        <MudNavLink Href="https://serve.pgas.ph/adsceir/kopSpC7YeY/PersonelSummaryRTPCR?Data=q2wmuki34jfMzGJ1Ao3TNQ==" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Group" Target="_blank">Personal RT-PCR Summary</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/hrmis/public/officeprofile" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.PersonPin" Target="_blank">Middle Mgt. Profile</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/hrmis/public/tripticketreport" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CarCrash" Target="_blank">Fuel on Trip </MudNavLink>
                    </MudNavGroup>
                    <MudNavGroup Title="Procurement" Icon="@Icons.Material.Filled.ShoppingCart" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="https://pgas.ph/pdm/allongoingpr" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AutoAwesomeMotion" Target="_blank">On Going PR</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/allreturnedpr" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AutoAwesomeMotion" Target="_blank">Returned PR</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/public/ppmputilization" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Timeline" Target="_blank">PPMP Utilization</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/public/report" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ChromeReaderMode" Target="_blank">Mode of Procurement</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/public/search" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ManageSearch" Target="_blank">Search PR</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/public/posummary" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LineWeight" Target="_blank">PO Report</MudNavLink>
                        <MudNavLink Href="/price-bulletin" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Payment">Price Bulletin</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/epslite/public/procureditems" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LineWeight" Target="_blank">Procured Items</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/TransactionReports" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FolderCopy" Target="_blank">Proc. Summary Report</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spms/home/trainingitems" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.CurrencyRuble" Target="_blank">Training Expenses</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/spmsv2/ICTReview" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SupervisedUserCircle" Target="_blank">ICT Equipment (AIP)</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/signatorysummary" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FileCopy" Target="_blank">Signatory Delay Summary</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/pdm/SignatoryDelays" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FileCopy" Target="_blank">Signatory Delay Transaction</MudNavLink>
                    </MudNavGroup>
                    <MudNavGroup Title="Expenditures" Icon="@Icons.Material.Filled.Payment" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="/fuel-consumption" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocalGasStation">Fuel Consumption</MudNavLink>
                    </MudNavGroup>
                    <MudNavGroup Title="Physical Resource" Icon="@Icons.Material.Filled.CollectionsBookmark" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="/vehicle-schedule" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.EditCalendar">Vehichle Schedule</MudNavLink>
                        <MudNavLink Href="/ict-inventory" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory">ICT Inventory</MudNavLink>
                        <MudNavLink Href="/is-inventory" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory">IS Inventory</MudNavLink>
                    </MudNavGroup>
                    <MudNavGroup Title="Health Management" Icon="@Icons.Material.Filled.MedicalInformation" @bind-Collapsed="_collapsed">
                        <MudNavLink Href="https://dopmh.pgas.ph/ihoms/RPTDOHNew" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.FolderCopy" Target="_blank">DOH Reports</MudNavLink>
                        <MudNavLink Href="https://pgas.ph/eis/meds" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Inventory" Target="_blank">Supplies Inventory</MudNavLink>
                    </MudNavGroup>
                    <MudNavLink Href="/system-updates" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CheckBox">System Updates</MudNavLink>
                </MudNavMenu>

            </MudPaper>

            @code {
        bool _collapsed = true;
            }
            <MudDivider />
            <!-- Dynamic External nav menu -->
            @if (externalLinks != null && externalLinks.Any())
            {
                <MudVirtualize Items="externalLinks" Context="parentlink">
                    @if (!string.IsNullOrEmpty(parentlink?.Parent_List_Link))
                    {
                        <MudNavLink Href="@parentlink?.Parent_List_Link" Target="_blank" Match="NavLinkMatch.Prefix" Icon="@GetIcon(parentlink?.Parent_List_Icon ?? "")">@parentlink?.Parent_List_Name</MudNavLink>
                    }
                    else
                    {
                        <MudNavGroup Title="@parentlink?.Parent_List_Name" Icon="@GetIcon(parentlink?.Parent_List_Icon ?? "")" Expanded="false">
                            <MudVirtualize Items="parentlink?.v_external_linkChildList" Context="childlink">
                                @if (!string.IsNullOrEmpty(childlink?.Child_List_Name))
                            {
                                DateTime currentDate = DateTime.UtcNow;
                                DateTime oneMonthAgo = currentDate.AddMonths(-1);
                                if (childlink.Child_List_Date_Created > oneMonthAgo)
                                {
                                    <MudNavLink Href="@childlink.Child_List_Link" Target="_blank" Match="NavLinkMatch.Prefix" Icon="@GetIcon(childlink?.Child_List_Icon ?? "")">
                                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            @childlink?.Child_List_Name
                                            <MudChip T="string" Class="pa-2 ma-0" Style="@($"color:{Colors.Shades.Black}; background:{Colors.Yellow.Default}")" Size="Size.Small">New</MudChip>
                                        </MudStack>
                                    </MudNavLink>
                                }
                                else
                                {
                                    <MudNavLink Href="@childlink?.Child_List_Link" Target="_blank" Match="NavLinkMatch.Prefix" Icon="@GetIcon(childlink?.Child_List_Icon ?? "")">@childlink?.Child_List_Name</MudNavLink>
                                }
                            }
                        </MudVirtualize>
                    </MudNavGroup>
                    }
                </MudVirtualize>
            }
            else
            {
                <MudStack Class="pl-5 pt-2" Spacing="2">
                    <MudSkeleton Width="50%" />
                    <MudSkeleton Width="35%" />
                    <MudSkeleton Width="60%" />
                    <MudSkeleton Width="57%" />
                    <MudSkeleton Width="80%" />
                </MudStack>
            }
        </MudNavMenu>
    </MudItem>
    <MudSpacer/>
    <MudItem xs="12">
        <MudText Typo="Typo.body2">
            <b>© 2023-2024</b>
        </MudText>
        <MudText Typo="Typo.body2" Style="font-size:13px">
            <b>Provincial Government of Agusan del Sur.</b>
        </MudText>
        <MudText Typo="Typo.body2" Style="font-size: 12px">
            All rights reserved. Developed under the leadership of Governor Santiago B. Cane, Jr.
        </MudText>
    </MudItem> 
</MudGrid>

@code {
    private readonly string API_URL = APIService.PGASPortalAPI;
    private List<v_external_linkParentListDTO>? externalLinks;
    private vw_pgas_employeesDTO? pgasEmployee;
    private UserService.eportalUser? eid;
    private int currentYear;

    public class v_external_linkParentListDTO
    {
        public string? Parent_List_Name { get; set; }
        public string? Parent_List_Icon { get; set; }
        public string? Parent_List_Link { get; set; }
        public DateTime? Parent_List_Date_Created { get; set; }
        public int? Parent_List_Order { get; set; }
        public List<v_external_linkChildListDTO>? v_external_linkChildList { get; set; }
    }

    public class v_external_linkChildListDTO
    {
        public string? Child_List_Name { get; set; }
        public string? Child_List_Link { get; set; }
        public string? Child_List_Icon { get; set; }
        public DateTime? Child_List_Date_Created { get; set; }
        public int? Child_List_Order { get; set; }
    }

    public partial class vw_pgas_employeesDTO
    {
        public long? eid { get; set; }
        public string? SwipeID { get; set; }
        public string? OfficeName { get; set; }
        public string? OfficeAbbr { get; set; }
        public string? EmployeeName { get; set; }
        public string? Position { get; set; }
        public int? SG { get; set; }
        public string? Status { get; set; }
        public bool? isactive { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        currentYear = DateTime.Now.Year;
        UserService.OnUserChanged += UpdateUser;
        await UpdateUserAsync();
        await GetExternalLinks();
    }

    private async Task UpdateUserAsync()
    {
        eid = await UserService.GetCurrentUserAsync();
        await SelectEmployee();
        StateHasChanged();
    }

    private void UpdateUser()
    {
        // Calling the async method from a non-async method
        _ = UpdateUserAsync();
    }

    private async Task GetExternalLinks()
    {
        try
        {
            using var httpClient = new HttpClient();
            HttpResponseMessage httpResponse = await httpClient.GetAsync($"{API_URL}/api/external_link");
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response

            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            externalLinks = await JsonSerializer.DeserializeAsync<List<v_external_linkParentListDTO>>(responseStream, options);
        }
        catch (HttpRequestException ex)
        {
            // Handle exception, log, or display an error message
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }

    private async Task SelectEmployee()
    {
        try
        {
            if (eid?.eid != null)
            {
                using HttpClient httpClient = new HttpClient();
                HttpResponseMessage httpResponse = await httpClient.GetAsync($"{API_URL}/api/vw_pgas_employeesDTO/id/{eid?.eid}");
                httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response

                string jsonResponse = await httpResponse.Content.ReadAsStringAsync();
                var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                pgasEmployee = JsonSerializer.Deserialize<vw_pgas_employeesDTO>(jsonResponse, options);
            }
        }
        catch (HttpRequestException ex)
        {
            // Handle exception, log, or display an error message
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
        catch (JsonException jsonEx)
        {
            // Handle JSON deserialization errors
            Console.WriteLine($"JSON error: {jsonEx.Message}");
        }
    }

    private string GetIcon(string iconName)
    {
        if (string.IsNullOrEmpty(iconName))
        {
            return string.Empty; // Return an empty string if the icon name is null or empty
        }

        // Attempt to get the icon from Icons.Custom.FileFormats
        var customIconType = typeof(Icons.Custom.FileFormats);
        var customIconField = customIconType.GetField(iconName);
        if (customIconField != null)
        {
            var customIconValue = customIconField.GetValue(null) as string;
            if (!string.IsNullOrEmpty(customIconValue))
            {
                return customIconValue;
            }
        }

        // Attempt to get the icon from Icons.Material.Filled
        var materialIconType = typeof(Icons.Material.Filled);
        var materialIconField = materialIconType.GetField(iconName);
        if (materialIconField != null)
        {
            var materialIconValue = materialIconField.GetValue(null) as string;
            if (!string.IsNullOrEmpty(materialIconValue))
            {
                return materialIconValue;
            }
        }

        // Return a default icon or empty string if not found
        return string.Empty;
    }
}
