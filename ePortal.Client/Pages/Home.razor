@page "/"
@using System.Net.Http
@using System.Text.Json
@using System.Threading.Tasks

<!-- MudCarousel for displaying images/icons -->
<MudPaper Class="ma-5" Elevation="0">
    <MudCarousel Class="mud-width-full" Style="height:400px;" ShowArrows="true" ShowBullets="true" EnableSwipeGesture="true" AutoCycle="true" TData="object">
        <!-- MudCarouselItem 1 -->
        <MudCarouselItem Transition="Transition.Slide" Color="@Color.Primary">
            <div class="d-flex" style="height:100%">
                <MudIcon Class="mx-auto my-auto" Icon="@Icons.Custom.Brands.MudBlazor" Size="@Size.Large" />
            </div>
        </MudCarouselItem>
        <!-- MudCarouselItem 2 -->
        <MudCarouselItem Transition="Transition.Slide" Color="@Color.Secondary">
            <div class="d-flex" style="height:100%">
                <MudIcon Class="mx-auto my-auto" Icon="@Icons.Custom.Brands.MudBlazor" Size="@Size.Large" />
            </div>
        </MudCarouselItem>
        <!-- MudCarouselItem 3 -->
        <MudCarouselItem Transition="Transition.Slide">
            <div class="d-flex" style="height:100%">
                <MudIcon Class="mx-auto my-auto" Icon="@Icons.Custom.Brands.MudBlazor" Color="@Color.Primary" Size="@Size.Large" />
            </div>
        </MudCarouselItem>
    </MudCarousel>
</MudPaper>

<!-- Gov and Verse Section -->
<MudStack Class="flex-wrap justify-center" Row="true">
    <MudCard Elevation="0" Outlined="true" Style="width: 61%">
        <MudStack Class="flex-wrap" Style="justify-content: flex-start" Row="true">
            <!-- Governor's SOPA Section -->
            <MudImage Fluid="true" Class="mt-1 ml-1" Width="250" Style="transform: rotateY(180deg);" Src="/Media Files/gov-image.png"></MudImage>
            <MudStack>
                <MudText>Governor's SOPA</MudText>
                <MudText>State of the Province Address</MudText>
                <MudCard Elevation="0">
                    <MudCardContent>
                        <MudText Typo="Typo.h5">Time Left:</MudText>
                        <MudText Typo="Typo.h3">@displayTime</MudText> <!-- Countdown timer -->
                    </MudCardContent>
                </MudCard>
                <MudText>Santiago B. Cane, Jr.</MudText>
                <MudText>Provincial Governor</MudText>
            </MudStack>
        </MudStack>
    </MudCard>
    <!-- Daily Word of God Section -->
    <MudCard Class="d-inline pa-2" Outlined="true" Style="width: 30%">
        <MudText Typo="Typo.h5">Our Daily Word of God </MudText>
        <MudDivider />
        @if (latestVerse != null)
        {
            <!-- Display the latest Bible verse -->
            <MudText Typo="Typo.subtitle2" Color="Color.Primary">@latestVerse.Chapter</MudText>
            <MudText Typo="Typo.subtitle1">@latestVerse.Verse</MudText>
        }
        else
        {
            <!-- Display a loading indicator if data is not available -->
            <MudStack Class="d-flex align-center mt-5">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            </MudStack>
        }
    </MudCard>
</MudStack>

<!--
Information Systems Section
-->
<MudStack Class="flex-wrap justify-center" Row="true">
    <!-- Check if information systems data is available -->
    @if (informationSystems != null && informationSystems.Any())
    {
        <!-- Iterate over each cluster of information systems -->
        @foreach (var cluster in informationSystems)
        {
            <!-- Display a card for each cluster -->
            <MudCard Elevation="0" Outlined="true" Class="four-card">
                <MudCardHeader Class="pa-0">
                    <!-- Display the cluster name in the card header -->
                    <MudCardContent>
                        <MudText Align="Align.Center">
                            @cluster.Cluster_Name
                        </MudText>
                    </MudCardContent>
                </MudCardHeader>
                <MudDivider />
                <MudCardContent Class="d-flex flex-wrap justify-center gap-3">
                    <!-- Iterate over each information system in the cluster -->
                    @foreach (var system in cluster.Information_Systems)
                    {
                        <!-- Display a button or badge for each information system -->
                        @if (system.Information_System_Platform == "Web App")
                        {
                            <!-- Display a button for web apps with a tooltip -->
                            <MudLink Href="@system.Information_System_Link" Target="_blank" Underline="Underline.None">
                                <MudTooltip Text="@system.Information_System_Name">
                                    <MudButton DisableElevation Variant="Variant.Filled" StartIcon="@(typeof(Icons.Material.Filled).GetField(system.Information_System_Icon)?.GetValue(null) as string)" Color="Color.Primary" Size="Size.Small">
                                        @system.Information_System_Abbreviation
                                    </MudButton>
                                </MudTooltip>
                            </MudLink>
                        }
                        else if (system.Information_System_Platform == "Desktop App")
                        {
                            <!-- Display a badge for desktop apps with a tooltip -->
                            <MudTooltip Text="@(system.Information_System_Name+" ("+system.Information_System_Platform+")")">
                                <MudBadge Bordered="true" Overlap="true" Icon="@Icons.Material.Filled.DesktopWindows" Color="Color.Primary">
                                    <MudButton DisableElevation Variant="Variant.Filled" StartIcon="@(typeof(Icons.Material.Filled).GetField(system.Information_System_Icon)?.GetValue(null) as string)" Color="Color.Primary" Size="Size.Small">
                                        @system.Information_System_Abbreviation
                                    </MudButton>
                                </MudBadge>
                            </MudTooltip>
                        }
                    }
                </MudCardContent>
            </MudCard>
        }
    }
    else
    {
        <!-- Display a loading indicator if data is not available -->
        <MudCard Elevation="0" Outlined="true" Class="four-card">
            <MudStack Class="d-flex align-center mt-5">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            </MudStack>
        </MudCard>
    }
</MudStack>

@code {
    // Get API URL
    private const string API_URL = "https://localhost:7049";

    // DTO class for the latest Bible verse
    public class BibleVerseLatestDTO
    {
        public string Verse { get; set; } = string.Empty;
        public string Chapter { get; set; } = string.Empty;
        public DateTime? Date { get; set; }
    }

    // DTO class for clustered information systems
    public class v_clustered_information_systemDTO
    {
        public string Cluster_Name { get; set; } = string.Empty;
        public string Cluster_Abbreviation { get; set; } = string.Empty;
        public string Cluster_Icon { get; set; } = string.Empty;
        public List<InformationSystemDTO>? Information_Systems { get; set; } // Updated to use InformationSystemDTO
    }

    // DTO class for individual information systems
    public class InformationSystemDTO
    {
        public string Information_System_Name { get; set; } = string.Empty;
        public string Information_System_Abbreviation { get; set; } = string.Empty;
        public string Information_System_Icon { get; set; } = string.Empty;
        public string Information_System_Link { get; set; } = string.Empty;
        public string Information_System_Platform { get; set; } = string.Empty;
    }

    // Variables for storing data and UI elements
    private BibleVerseLatestDTO? latestVerse;
    private List<v_clustered_information_systemDTO>? informationSystems;
    private string displayTime;
    private DateTime targetTime = new DateTime(2024, 6, 16, 8, 0, 0); // Specify your target date and time here

    // Initialization method to fetch data and update UI elements
    protected override async Task OnInitializedAsync()
    {
        UpdateTime(); // Start updating the countdown timer
        await GetLatestVerse(); // Fetch the latest Bible verse
        await GetGroupedClusters(); // Fetch grouped information systems
    }

    // Method to update the countdown timer every second
    private async Task UpdateTime()
    {
        while (true)
        {
            if (targetTime <= DateTime.UtcNow) // Check if the target date has passed
            {
                // Calculate the target date for the next year on June 16
                targetTime = targetTime.AddYears(1);
            }

            TimeSpan remainingTime = targetTime - DateTime.UtcNow;
            displayTime = $"{remainingTime.Days}d {remainingTime.Hours:D2}h {remainingTime.Minutes:D2}m {remainingTime.Seconds:D2}s";
            await Task.Delay(1000); // Update every second
            StateHasChanged(); // Notify Blazor to update the UI
        }
    }

    // Method to fetch the latest Bible verse from the API
    private async Task GetLatestVerse()
    {
        try
        {
            using HttpClient httpClient = new HttpClient();
            HttpResponseMessage httpResponse = await httpClient.GetAsync(API_URL + "/api/bible_verses/latest");
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response
            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            latestVerse = await JsonSerializer.DeserializeAsync<BibleVerseLatestDTO>(responseStream,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        catch (HttpRequestException ex)
        {
            // Handle exception, log, or display an error message
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }

    // Method to fetch grouped information systems from the API
    private async Task GetGroupedClusters()
    {
        try
        {
            using HttpClient httpClient = new HttpClient();
            HttpResponseMessage httpResponse = await httpClient.GetAsync(API_URL + "/api/v_clustered_information_system");
            httpResponse.EnsureSuccessStatusCode(); // Ensure a successful response
            using var responseStream = await httpResponse.Content.ReadAsStreamAsync();
            informationSystems = await JsonSerializer.DeserializeAsync<List<v_clustered_information_systemDTO>>(responseStream,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        catch (HttpRequestException ex)
        {
            // Handle exception, log, or display an error message
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
    }
}
